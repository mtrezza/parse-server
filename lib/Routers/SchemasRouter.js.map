{"version":3,"sources":["../../src/Routers/SchemasRouter.js"],"names":["Parse","require","SchemaController","classNameMismatchResponse","bodyClass","pathClass","Error","INVALID_CLASS_NAME","getAllSchemas","req","config","database","loadSchema","clearCache","then","schemaController","getAllClasses","schemas","response","results","getOneSchema","className","params","schema","catch","error","undefined","INTERNAL_SERVER_ERROR","createSchema","auth","isReadOnly","OPERATION_FORBIDDEN","body","path","addClassIfNotExists","fields","classLevelPermissions","indexes","modifySchema","submittedFields","updateClass","result","deleteSchema","classNameIsValid","invalidClassNameMessage","SchemasRouter","PromiseRouter","mountRoutes","route","middleware","promiseEnforceMasterKeyAccess"],"mappings":"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","sourcesContent":["// schemas.js\n\nvar Parse = require('parse/node').Parse,\n  SchemaController = require('../Controllers/SchemaController');\n\nimport PromiseRouter from '../PromiseRouter';\nimport * as middleware from '../middlewares';\n\nfunction classNameMismatchResponse(bodyClass, pathClass) {\n  throw new Parse.Error(\n    Parse.Error.INVALID_CLASS_NAME,\n    `Class name mismatch between ${bodyClass} and ${pathClass}.`\n  );\n}\n\nfunction getAllSchemas(req) {\n  return req.config.database\n    .loadSchema({ clearCache: true })\n    .then(schemaController => schemaController.getAllClasses(true))\n    .then(schemas => ({ response: { results: schemas } }));\n}\n\nfunction getOneSchema(req) {\n  const className = req.params.className;\n  return req.config.database\n    .loadSchema({ clearCache: true })\n    .then(schemaController => schemaController.getOneSchema(className, true))\n    .then(schema => ({ response: schema }))\n    .catch(error => {\n      if (error === undefined) {\n        throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, `Class ${className} does not exist.`);\n      } else {\n        throw new Parse.Error(Parse.Error.INTERNAL_SERVER_ERROR, 'Database adapter error.');\n      }\n    });\n}\n\nfunction createSchema(req) {\n  if (req.auth.isReadOnly) {\n    throw new Parse.Error(\n      Parse.Error.OPERATION_FORBIDDEN,\n      \"read-only masterKey isn't allowed to create a schema.\"\n    );\n  }\n  if (req.params.className && req.body.className) {\n    if (req.params.className != req.body.className) {\n      return classNameMismatchResponse(req.body.className, req.params.className);\n    }\n  }\n\n  const className = req.params.className || req.body.className;\n  if (!className) {\n    throw new Parse.Error(135, `POST ${req.path} needs a class name.`);\n  }\n\n  return req.config.database\n    .loadSchema({ clearCache: true })\n    .then(schema =>\n      schema.addClassIfNotExists(\n        className,\n        req.body.fields,\n        req.body.classLevelPermissions,\n        req.body.indexes\n      )\n    )\n    .then(schema => ({ response: schema }));\n}\n\nfunction modifySchema(req) {\n  if (req.auth.isReadOnly) {\n    throw new Parse.Error(\n      Parse.Error.OPERATION_FORBIDDEN,\n      \"read-only masterKey isn't allowed to update a schema.\"\n    );\n  }\n  if (req.body.className && req.body.className != req.params.className) {\n    return classNameMismatchResponse(req.body.className, req.params.className);\n  }\n\n  const submittedFields = req.body.fields || {};\n  const className = req.params.className;\n\n  return req.config.database\n    .loadSchema({ clearCache: true })\n    .then(schema =>\n      schema.updateClass(\n        className,\n        submittedFields,\n        req.body.classLevelPermissions,\n        req.body.indexes,\n        req.config.database\n      )\n    )\n    .then(result => ({ response: result }));\n}\n\nconst deleteSchema = req => {\n  if (req.auth.isReadOnly) {\n    throw new Parse.Error(\n      Parse.Error.OPERATION_FORBIDDEN,\n      \"read-only masterKey isn't allowed to delete a schema.\"\n    );\n  }\n  if (!SchemaController.classNameIsValid(req.params.className)) {\n    throw new Parse.Error(\n      Parse.Error.INVALID_CLASS_NAME,\n      SchemaController.invalidClassNameMessage(req.params.className)\n    );\n  }\n  return req.config.database.deleteSchema(req.params.className).then(() => ({ response: {} }));\n};\n\nexport class SchemasRouter extends PromiseRouter {\n  mountRoutes() {\n    this.route('GET', '/schemas', middleware.promiseEnforceMasterKeyAccess, getAllSchemas);\n    this.route(\n      'GET',\n      '/schemas/:className',\n      middleware.promiseEnforceMasterKeyAccess,\n      getOneSchema\n    );\n    this.route('POST', '/schemas', middleware.promiseEnforceMasterKeyAccess, createSchema);\n    this.route(\n      'POST',\n      '/schemas/:className',\n      middleware.promiseEnforceMasterKeyAccess,\n      createSchema\n    );\n    this.route(\n      'PUT',\n      '/schemas/:className',\n      middleware.promiseEnforceMasterKeyAccess,\n      modifySchema\n    );\n    this.route(\n      'DELETE',\n      '/schemas/:className',\n      middleware.promiseEnforceMasterKeyAccess,\n      deleteSchema\n    );\n  }\n}\n"],"file":"SchemasRouter.js"}