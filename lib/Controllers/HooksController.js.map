{"version":3,"sources":["../../src/Controllers/HooksController.js"],"names":["DefaultHooksCollectionName","HTTPAgents","http","Agent","keepAlive","https","HooksController","constructor","applicationId","databaseController","webhookKey","_applicationId","_webhookKey","database","load","_getHooks","then","hooks","forEach","hook","addHookToTriggers","getFunction","functionName","results","getFunctions","$exists","getTrigger","className","triggerName","getTriggers","deleteFunction","triggers","removeFunction","_removeHooks","deleteTrigger","removeTrigger","query","find","map","result","objectId","destroy","Promise","resolve","saveHook","url","Parse","Error","update","upsert","wrappedFunction","wrapToHTTPRequest","addTrigger","addFunction","addHook","createOrUpdateHook","aHook","Types","createHook","updateHook","key","req","jsonBody","i","object","toJSON","original","jsonRequest","headers","body","method","agent","startsWith","logger","warn","response","err","data","JSON","parse","e","error","code","partialResponse","substring","success","createdAt","updatedAt"],"mappings":"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","sourcesContent":["/** @flow weak */\n\nimport * as triggers from '../triggers';\n// @flow-disable-next\nimport * as Parse from 'parse/node';\n// @flow-disable-next\nimport request from '../request';\nimport { logger } from '../logger';\nimport http from 'http';\nimport https from 'https';\n\nconst DefaultHooksCollectionName = '_Hooks';\nconst HTTPAgents = {\n  http: new http.Agent({ keepAlive: true }),\n  https: new https.Agent({ keepAlive: true }),\n};\n\nexport class HooksController {\n  _applicationId: string;\n  _webhookKey: string;\n  database: any;\n\n  constructor(applicationId: string, databaseController, webhookKey) {\n    this._applicationId = applicationId;\n    this._webhookKey = webhookKey;\n    this.database = databaseController;\n  }\n\n  load() {\n    return this._getHooks().then(hooks => {\n      hooks = hooks || [];\n      hooks.forEach(hook => {\n        this.addHookToTriggers(hook);\n      });\n    });\n  }\n\n  getFunction(functionName) {\n    return this._getHooks({ functionName: functionName }).then(results => results[0]);\n  }\n\n  getFunctions() {\n    return this._getHooks({ functionName: { $exists: true } });\n  }\n\n  getTrigger(className, triggerName) {\n    return this._getHooks({\n      className: className,\n      triggerName: triggerName,\n    }).then(results => results[0]);\n  }\n\n  getTriggers() {\n    return this._getHooks({\n      className: { $exists: true },\n      triggerName: { $exists: true },\n    });\n  }\n\n  deleteFunction(functionName) {\n    triggers.removeFunction(functionName, this._applicationId);\n    return this._removeHooks({ functionName: functionName });\n  }\n\n  deleteTrigger(className, triggerName) {\n    triggers.removeTrigger(triggerName, className, this._applicationId);\n    return this._removeHooks({\n      className: className,\n      triggerName: triggerName,\n    });\n  }\n\n  _getHooks(query = {}) {\n    return this.database.find(DefaultHooksCollectionName, query).then(results => {\n      return results.map(result => {\n        delete result.objectId;\n        return result;\n      });\n    });\n  }\n\n  _removeHooks(query) {\n    return this.database.destroy(DefaultHooksCollectionName, query).then(() => {\n      return Promise.resolve({});\n    });\n  }\n\n  saveHook(hook) {\n    var query;\n    if (hook.functionName && hook.url) {\n      query = { functionName: hook.functionName };\n    } else if (hook.triggerName && hook.className && hook.url) {\n      query = { className: hook.className, triggerName: hook.triggerName };\n    } else {\n      throw new Parse.Error(143, 'invalid hook declaration');\n    }\n    return this.database\n      .update(DefaultHooksCollectionName, query, hook, { upsert: true })\n      .then(() => {\n        return Promise.resolve(hook);\n      });\n  }\n\n  addHookToTriggers(hook) {\n    var wrappedFunction = wrapToHTTPRequest(hook, this._webhookKey);\n    wrappedFunction.url = hook.url;\n    if (hook.className) {\n      triggers.addTrigger(hook.triggerName, hook.className, wrappedFunction, this._applicationId);\n    } else {\n      triggers.addFunction(hook.functionName, wrappedFunction, null, this._applicationId);\n    }\n  }\n\n  addHook(hook) {\n    this.addHookToTriggers(hook);\n    return this.saveHook(hook);\n  }\n\n  createOrUpdateHook(aHook) {\n    var hook;\n    if (aHook && aHook.functionName && aHook.url) {\n      hook = {};\n      hook.functionName = aHook.functionName;\n      hook.url = aHook.url;\n    } else if (\n      aHook &&\n      aHook.className &&\n      aHook.url &&\n      aHook.triggerName &&\n      triggers.Types[aHook.triggerName]\n    ) {\n      hook = {};\n      hook.className = aHook.className;\n      hook.url = aHook.url;\n      hook.triggerName = aHook.triggerName;\n    } else {\n      throw new Parse.Error(143, 'invalid hook declaration');\n    }\n\n    return this.addHook(hook);\n  }\n\n  createHook(aHook) {\n    if (aHook.functionName) {\n      return this.getFunction(aHook.functionName).then(result => {\n        if (result) {\n          throw new Parse.Error(143, `function name: ${aHook.functionName} already exits`);\n        } else {\n          return this.createOrUpdateHook(aHook);\n        }\n      });\n    } else if (aHook.className && aHook.triggerName) {\n      return this.getTrigger(aHook.className, aHook.triggerName).then(result => {\n        if (result) {\n          throw new Parse.Error(\n            143,\n            `class ${aHook.className} already has trigger ${aHook.triggerName}`\n          );\n        }\n        return this.createOrUpdateHook(aHook);\n      });\n    }\n\n    throw new Parse.Error(143, 'invalid hook declaration');\n  }\n\n  updateHook(aHook) {\n    if (aHook.functionName) {\n      return this.getFunction(aHook.functionName).then(result => {\n        if (result) {\n          return this.createOrUpdateHook(aHook);\n        }\n        throw new Parse.Error(143, `no function named: ${aHook.functionName} is defined`);\n      });\n    } else if (aHook.className && aHook.triggerName) {\n      return this.getTrigger(aHook.className, aHook.triggerName).then(result => {\n        if (result) {\n          return this.createOrUpdateHook(aHook);\n        }\n        throw new Parse.Error(143, `class ${aHook.className} does not exist`);\n      });\n    }\n    throw new Parse.Error(143, 'invalid hook declaration');\n  }\n}\n\nfunction wrapToHTTPRequest(hook, key) {\n  return req => {\n    const jsonBody = {};\n    for (var i in req) {\n      jsonBody[i] = req[i];\n    }\n    if (req.object) {\n      jsonBody.object = req.object.toJSON();\n      jsonBody.object.className = req.object.className;\n    }\n    if (req.original) {\n      jsonBody.original = req.original.toJSON();\n      jsonBody.original.className = req.original.className;\n    }\n    const jsonRequest: any = {\n      url: hook.url,\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: jsonBody,\n      method: 'POST',\n    };\n\n    const agent = hook.url.startsWith('https') ? HTTPAgents['https'] : HTTPAgents['http'];\n    jsonRequest.agent = agent;\n\n    if (key) {\n      jsonRequest.headers['X-Parse-Webhook-Key'] = key;\n    } else {\n      logger.warn('Making outgoing webhook request without webhookKey being set!');\n    }\n    return request(jsonRequest).then(response => {\n      let err;\n      let result;\n      let body = response.data;\n      if (body) {\n        if (typeof body === 'string') {\n          try {\n            body = JSON.parse(body);\n          } catch (e) {\n            err = {\n              error: 'Malformed response',\n              code: -1,\n              partialResponse: body.substring(0, 100),\n            };\n          }\n        }\n        if (!err) {\n          result = body.success;\n          err = body.error;\n        }\n      }\n      if (err) {\n        throw err;\n      } else if (hook.triggerName === 'beforeSave') {\n        if (typeof result === 'object') {\n          delete result.createdAt;\n          delete result.updatedAt;\n          delete result.className;\n        }\n        return { object: result };\n      } else {\n        return result;\n      }\n    });\n  };\n}\n\nexport default HooksController;\n"],"file":"HooksController.js"}