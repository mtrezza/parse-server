{"version":3,"sources":["../../../src/Adapters/Auth/vkontakte.js"],"names":["httpsRequest","require","Parse","validateAuthData","authData","params","vkOAuth2Request","then","response","access_token","request","apiVersion","length","id","Error","OBJECT_NOT_FOUND","Promise","resolve","appIds","appSecret","validateAppId","host","path","get","module","exports"],"mappings":"AAAA,a,CAEA;;AAEA,MAAMA,YAAY,GAAGC,OAAO,CAAC,gBAAD,CAA5B;;AACA,IAAIC,KAAK,GAAGD,OAAO,CAAC,YAAD,CAAP,CAAsBC,KAAlC,C,CAEA;;;AACA,SAASC,gBAAT,CAA0BC,QAA1B,EAAoCC,MAApC,EAA4C;AAC1C,SAAOC,eAAe,CAACD,MAAD,CAAf,CAAwBE,IAAxB,CAA6B,UAAUC,QAAV,EAAoB;AACtD,QAAIA,QAAQ,IAAIA,QAAQ,CAACC,YAAzB,EAAuC;AACrC,aAAOC,OAAO,CACZ,YADY,EAEZ,mCAAmCN,QAAQ,CAACK,YAA5C,GAA2D,KAA3D,GAAmEJ,MAAM,CAACM,UAF9D,CAAP,CAGLJ,IAHK,CAGA,UAAUC,QAAV,EAAoB;AACzB,YACEA,QAAQ,IACRA,QAAQ,CAACA,QADT,IAEAA,QAAQ,CAACA,QAAT,CAAkBI,MAFlB,IAGAJ,QAAQ,CAACA,QAAT,CAAkB,CAAlB,EAAqBK,EAArB,IAA2BT,QAAQ,CAACS,EAJtC,EAKE;AACA;AACD;;AACD,cAAM,IAAIX,KAAK,CAACY,KAAV,CAAgBZ,KAAK,CAACY,KAAN,CAAYC,gBAA5B,EAA8C,mCAA9C,CAAN;AACD,OAbM,CAAP;AAcD;;AACD,UAAM,IAAIb,KAAK,CAACY,KAAV,CAAgBZ,KAAK,CAACY,KAAN,CAAYC,gBAA5B,EAA8C,sCAA9C,CAAN;AACD,GAlBM,CAAP;AAmBD;;AAED,SAAST,eAAT,CAAyBD,MAAzB,EAAiC;AAC/B,SAAO,IAAIW,OAAJ,CAAY,UAAUC,OAAV,EAAmB;AACpC,QACE,CAACZ,MAAD,IACA,CAACA,MAAM,CAACa,MADR,IAEA,CAACb,MAAM,CAACa,MAAP,CAAcN,MAFf,IAGA,CAACP,MAAM,CAACc,SAHR,IAIA,CAACd,MAAM,CAACc,SAAP,CAAiBP,MALpB,EAME;AACA,YAAM,IAAIV,KAAK,CAACY,KAAV,CACJZ,KAAK,CAACY,KAAN,CAAYC,gBADR,EAEJ,yDAFI,CAAN;AAID;;AACD,QAAI,CAACV,MAAM,CAACM,UAAZ,EAAwB;AACtBN,MAAAA,MAAM,CAACM,UAAP,GAAoB,OAApB;AACD;;AACDM,IAAAA,OAAO;AACR,GAjBM,EAiBJV,IAjBI,CAiBC,YAAY;AAClB,WAAOG,OAAO,CACZ,cADY,EAEZ,4BACEL,MAAM,CAACa,MADT,GAEE,iBAFF,GAGEb,MAAM,CAACc,SAHT,GAIE,KAJF,GAKEd,MAAM,CAACM,UALT,GAME,gCARU,CAAd;AAUD,GA5BM,CAAP;AA6BD,C,CAED;;;AACA,SAASS,aAAT,GAAyB;AACvB,SAAOJ,OAAO,CAACC,OAAR,EAAP;AACD,C,CAED;;;AACA,SAASP,OAAT,CAAiBW,IAAjB,EAAuBC,IAAvB,EAA6B;AAC3B,SAAOtB,YAAY,CAACuB,GAAb,CAAiB,aAAaF,IAAb,GAAoB,GAApB,GAA0BC,IAA3C,CAAP;AACD;;AAEDE,MAAM,CAACC,OAAP,GAAiB;AACfL,EAAAA,aAAa,EAAEA,aADA;AAEfjB,EAAAA,gBAAgB,EAAEA;AAFH,CAAjB","sourcesContent":["'use strict';\n\n// Helper functions for accessing the vkontakte API.\n\nconst httpsRequest = require('./httpsRequest');\nvar Parse = require('parse/node').Parse;\n\n// Returns a promise that fulfills iff this user id is valid.\nfunction validateAuthData(authData, params) {\n  return vkOAuth2Request(params).then(function (response) {\n    if (response && response.access_token) {\n      return request(\n        'api.vk.com',\n        'method/users.get?access_token=' + authData.access_token + '&v=' + params.apiVersion\n      ).then(function (response) {\n        if (\n          response &&\n          response.response &&\n          response.response.length &&\n          response.response[0].id == authData.id\n        ) {\n          return;\n        }\n        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Vk auth is invalid for this user.');\n      });\n    }\n    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Vk appIds or appSecret is incorrect.');\n  });\n}\n\nfunction vkOAuth2Request(params) {\n  return new Promise(function (resolve) {\n    if (\n      !params ||\n      !params.appIds ||\n      !params.appIds.length ||\n      !params.appSecret ||\n      !params.appSecret.length\n    ) {\n      throw new Parse.Error(\n        Parse.Error.OBJECT_NOT_FOUND,\n        'Vk auth is not configured. Missing appIds or appSecret.'\n      );\n    }\n    if (!params.apiVersion) {\n      params.apiVersion = '5.124';\n    }\n    resolve();\n  }).then(function () {\n    return request(\n      'oauth.vk.com',\n      'access_token?client_id=' +\n        params.appIds +\n        '&client_secret=' +\n        params.appSecret +\n        '&v=' +\n        params.apiVersion +\n        '&grant_type=client_credentials'\n    );\n  });\n}\n\n// Returns a promise that fulfills iff this app id is valid.\nfunction validateAppId() {\n  return Promise.resolve();\n}\n\n// A promisey wrapper for api requests\nfunction request(host, path) {\n  return httpsRequest.get('https://' + host + '/' + path);\n}\n\nmodule.exports = {\n  validateAppId: validateAppId,\n  validateAuthData: validateAuthData,\n};\n"],"file":"vkontakte.js"}