"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createClient = createClient;

const parser = require('./PostgresConfigParser');

function createClient(uri, databaseOptions) {
  let dbOptions = {};
  databaseOptions = databaseOptions || {};

  if (uri) {
    dbOptions = parser.getDatabaseOptionsFromURI(uri);
  }

  for (const key in databaseOptions) {
    dbOptions[key] = databaseOptions[key];
  }

  const initOptions = dbOptions.initOptions || {};
  initOptions.noWarnings = process && process.env.TESTING;

  const pgp = require('pg-promise')(initOptions);

  const client = pgp(dbOptions);

  if (process.env.PARSE_SERVER_LOG_LEVEL === 'debug') {
    const monitor = require('pg-monitor');

    try {
      monitor.attach(initOptions);
    } catch (e) {
      monitor.detach();
      monitor.attach(initOptions);
    }
  }

  if (dbOptions.pgOptions) {
    for (const key in dbOptions.pgOptions) {
      pgp.pg.defaults[key] = dbOptions.pgOptions[key];
    }
  }

  return {
    client,
    pgp
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9BZGFwdGVycy9TdG9yYWdlL1Bvc3RncmVzL1Bvc3RncmVzQ2xpZW50LmpzIl0sIm5hbWVzIjpbInBhcnNlciIsInJlcXVpcmUiLCJjcmVhdGVDbGllbnQiLCJ1cmkiLCJkYXRhYmFzZU9wdGlvbnMiLCJkYk9wdGlvbnMiLCJnZXREYXRhYmFzZU9wdGlvbnNGcm9tVVJJIiwia2V5IiwiaW5pdE9wdGlvbnMiLCJub1dhcm5pbmdzIiwicHJvY2VzcyIsImVudiIsIlRFU1RJTkciLCJwZ3AiLCJjbGllbnQiLCJQQVJTRV9TRVJWRVJfTE9HX0xFVkVMIiwibW9uaXRvciIsImF0dGFjaCIsImUiLCJkZXRhY2giLCJwZ09wdGlvbnMiLCJwZyIsImRlZmF1bHRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUEsTUFBTUEsTUFBTSxHQUFHQyxPQUFPLENBQUMsd0JBQUQsQ0FBdEI7O0FBRU8sU0FBU0MsWUFBVCxDQUFzQkMsR0FBdEIsRUFBMkJDLGVBQTNCLEVBQTRDO0FBQ2pELE1BQUlDLFNBQVMsR0FBRyxFQUFoQjtBQUNBRCxFQUFBQSxlQUFlLEdBQUdBLGVBQWUsSUFBSSxFQUFyQzs7QUFFQSxNQUFJRCxHQUFKLEVBQVM7QUFDUEUsSUFBQUEsU0FBUyxHQUFHTCxNQUFNLENBQUNNLHlCQUFQLENBQWlDSCxHQUFqQyxDQUFaO0FBQ0Q7O0FBRUQsT0FBSyxNQUFNSSxHQUFYLElBQWtCSCxlQUFsQixFQUFtQztBQUNqQ0MsSUFBQUEsU0FBUyxDQUFDRSxHQUFELENBQVQsR0FBaUJILGVBQWUsQ0FBQ0csR0FBRCxDQUFoQztBQUNEOztBQUVELFFBQU1DLFdBQVcsR0FBR0gsU0FBUyxDQUFDRyxXQUFWLElBQXlCLEVBQTdDO0FBQ0FBLEVBQUFBLFdBQVcsQ0FBQ0MsVUFBWixHQUF5QkMsT0FBTyxJQUFJQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsT0FBaEQ7O0FBRUEsUUFBTUMsR0FBRyxHQUFHWixPQUFPLENBQUMsWUFBRCxDQUFQLENBQXNCTyxXQUF0QixDQUFaOztBQUNBLFFBQU1NLE1BQU0sR0FBR0QsR0FBRyxDQUFDUixTQUFELENBQWxCOztBQUVBLE1BQUlLLE9BQU8sQ0FBQ0MsR0FBUixDQUFZSSxzQkFBWixLQUF1QyxPQUEzQyxFQUFvRDtBQUNsRCxVQUFNQyxPQUFPLEdBQUdmLE9BQU8sQ0FBQyxZQUFELENBQXZCOztBQUNBLFFBQUk7QUFDRmUsTUFBQUEsT0FBTyxDQUFDQyxNQUFSLENBQWVULFdBQWY7QUFDRCxLQUZELENBRUUsT0FBT1UsQ0FBUCxFQUFVO0FBQ1ZGLE1BQUFBLE9BQU8sQ0FBQ0csTUFBUjtBQUNBSCxNQUFBQSxPQUFPLENBQUNDLE1BQVIsQ0FBZVQsV0FBZjtBQUNEO0FBQ0Y7O0FBRUQsTUFBSUgsU0FBUyxDQUFDZSxTQUFkLEVBQXlCO0FBQ3ZCLFNBQUssTUFBTWIsR0FBWCxJQUFrQkYsU0FBUyxDQUFDZSxTQUE1QixFQUF1QztBQUNyQ1AsTUFBQUEsR0FBRyxDQUFDUSxFQUFKLENBQU9DLFFBQVAsQ0FBZ0JmLEdBQWhCLElBQXVCRixTQUFTLENBQUNlLFNBQVYsQ0FBb0JiLEdBQXBCLENBQXZCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFPO0FBQUVPLElBQUFBLE1BQUY7QUFBVUQsSUFBQUE7QUFBVixHQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXJzZXIgPSByZXF1aXJlKCcuL1Bvc3RncmVzQ29uZmlnUGFyc2VyJyk7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDbGllbnQodXJpLCBkYXRhYmFzZU9wdGlvbnMpIHtcbiAgbGV0IGRiT3B0aW9ucyA9IHt9O1xuICBkYXRhYmFzZU9wdGlvbnMgPSBkYXRhYmFzZU9wdGlvbnMgfHwge307XG5cbiAgaWYgKHVyaSkge1xuICAgIGRiT3B0aW9ucyA9IHBhcnNlci5nZXREYXRhYmFzZU9wdGlvbnNGcm9tVVJJKHVyaSk7XG4gIH1cblxuICBmb3IgKGNvbnN0IGtleSBpbiBkYXRhYmFzZU9wdGlvbnMpIHtcbiAgICBkYk9wdGlvbnNba2V5XSA9IGRhdGFiYXNlT3B0aW9uc1trZXldO1xuICB9XG5cbiAgY29uc3QgaW5pdE9wdGlvbnMgPSBkYk9wdGlvbnMuaW5pdE9wdGlvbnMgfHwge307XG4gIGluaXRPcHRpb25zLm5vV2FybmluZ3MgPSBwcm9jZXNzICYmIHByb2Nlc3MuZW52LlRFU1RJTkc7XG5cbiAgY29uc3QgcGdwID0gcmVxdWlyZSgncGctcHJvbWlzZScpKGluaXRPcHRpb25zKTtcbiAgY29uc3QgY2xpZW50ID0gcGdwKGRiT3B0aW9ucyk7XG5cbiAgaWYgKHByb2Nlc3MuZW52LlBBUlNFX1NFUlZFUl9MT0dfTEVWRUwgPT09ICdkZWJ1ZycpIHtcbiAgICBjb25zdCBtb25pdG9yID0gcmVxdWlyZSgncGctbW9uaXRvcicpO1xuICAgIHRyeSB7XG4gICAgICBtb25pdG9yLmF0dGFjaChpbml0T3B0aW9ucyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbW9uaXRvci5kZXRhY2goKTtcbiAgICAgIG1vbml0b3IuYXR0YWNoKGluaXRPcHRpb25zKTtcbiAgICB9XG4gIH1cblxuICBpZiAoZGJPcHRpb25zLnBnT3B0aW9ucykge1xuICAgIGZvciAoY29uc3Qga2V5IGluIGRiT3B0aW9ucy5wZ09wdGlvbnMpIHtcbiAgICAgIHBncC5wZy5kZWZhdWx0c1trZXldID0gZGJPcHRpb25zLnBnT3B0aW9uc1trZXldO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7IGNsaWVudCwgcGdwIH07XG59XG4iXX0=