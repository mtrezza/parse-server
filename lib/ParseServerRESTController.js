"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ParseServerRESTController = ParseServerRESTController;
exports.default = void 0;

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const Config = require('./Config');

const Auth = require('./Auth');

const RESTController = require('parse/lib/node/RESTController');

const URL = require('url');

const Parse = require('parse/node');

function getSessionToken(options) {
  if (options && typeof options.sessionToken === 'string') {
    return Promise.resolve(options.sessionToken);
  }

  return Promise.resolve(null);
}

function getAuth(options = {}, config) {
  const installationId = options.installationId || 'cloud';

  if (options.useMasterKey) {
    return Promise.resolve(new Auth.Auth({
      config,
      isMaster: true,
      installationId
    }));
  }

  return getSessionToken(options).then(sessionToken => {
    if (sessionToken) {
      options.sessionToken = sessionToken;
      return Auth.getAuthForSessionToken({
        config,
        sessionToken: sessionToken,
        installationId
      });
    } else {
      return Promise.resolve(new Auth.Auth({
        config,
        installationId
      }));
    }
  });
}

function ParseServerRESTController(applicationId, router) {
  function handleRequest(method, path, data = {}, options = {}, config) {
    // Store the arguments, for later use if internal fails
    const args = arguments;

    if (!config) {
      config = Config.get(applicationId);
    }

    const serverURL = URL.parse(config.serverURL);

    if (path.indexOf(serverURL.path) === 0) {
      path = path.slice(serverURL.path.length, path.length);
    }

    if (path[0] !== '/') {
      path = '/' + path;
    }

    if (path === '/batch') {
      const batch = transactionRetries => {
        let initialPromise = Promise.resolve();

        if (data.transaction === true) {
          initialPromise = config.database.createTransactionalSession();
        }

        return initialPromise.then(() => {
          const promises = data.requests.map(request => {
            return handleRequest(request.method, request.path, request.body, options, config).then(response => {
              if (options.returnStatus) {
                const status = response._status;
                delete response._status;
                return {
                  success: response,
                  _status: status
                };
              }

              return {
                success: response
              };
            }, error => {
              return {
                error: {
                  code: error.code,
                  error: error.message
                }
              };
            });
          });
          return Promise.all(promises).then(result => {
            if (data.transaction === true) {
              if (result.find(resultItem => typeof resultItem.error === 'object')) {
                return config.database.abortTransactionalSession().then(() => {
                  return Promise.reject(result);
                });
              } else {
                return config.database.commitTransactionalSession().then(() => {
                  return result;
                });
              }
            } else {
              return result;
            }
          }).catch(error => {
            if (error && error.find(errorItem => typeof errorItem.error === 'object' && errorItem.error.code === 251) && transactionRetries > 0) {
              return batch(transactionRetries - 1);
            }

            throw error;
          });
        });
      };

      return batch(5);
    }

    let query;

    if (method === 'GET') {
      query = data;
    }

    return new Promise((resolve, reject) => {
      getAuth(options, config).then(auth => {
        const request = {
          body: data,
          config,
          auth,
          info: {
            applicationId: applicationId,
            sessionToken: options.sessionToken,
            installationId: options.installationId,
            context: options.context || {} // Add context

          },
          query
        };
        return Promise.resolve().then(() => {
          return router.tryRouteRequest(method, path, request);
        }).then(resp => {
          const {
            response,
            status
          } = resp;

          if (options.returnStatus) {
            resolve(_objectSpread(_objectSpread({}, response), {}, {
              _status: status
            }));
          } else {
            resolve(response);
          }
        }, err => {
          if (err instanceof Parse.Error && err.code == Parse.Error.INVALID_JSON && err.message == `cannot route ${method} ${path}`) {
            RESTController.request.apply(null, args).then(resolve, reject);
          } else {
            reject(err);
          }
        });
      }, reject);
    });
  }

  return {
    request: handleRequest,
    ajax: RESTController.ajax
  };
}

var _default = ParseServerRESTController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9QYXJzZVNlcnZlclJFU1RDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkNvbmZpZyIsInJlcXVpcmUiLCJBdXRoIiwiUkVTVENvbnRyb2xsZXIiLCJVUkwiLCJQYXJzZSIsImdldFNlc3Npb25Ub2tlbiIsIm9wdGlvbnMiLCJzZXNzaW9uVG9rZW4iLCJQcm9taXNlIiwicmVzb2x2ZSIsImdldEF1dGgiLCJjb25maWciLCJpbnN0YWxsYXRpb25JZCIsInVzZU1hc3RlcktleSIsImlzTWFzdGVyIiwidGhlbiIsImdldEF1dGhGb3JTZXNzaW9uVG9rZW4iLCJQYXJzZVNlcnZlclJFU1RDb250cm9sbGVyIiwiYXBwbGljYXRpb25JZCIsInJvdXRlciIsImhhbmRsZVJlcXVlc3QiLCJtZXRob2QiLCJwYXRoIiwiZGF0YSIsImFyZ3MiLCJhcmd1bWVudHMiLCJnZXQiLCJzZXJ2ZXJVUkwiLCJwYXJzZSIsImluZGV4T2YiLCJzbGljZSIsImxlbmd0aCIsImJhdGNoIiwidHJhbnNhY3Rpb25SZXRyaWVzIiwiaW5pdGlhbFByb21pc2UiLCJ0cmFuc2FjdGlvbiIsImRhdGFiYXNlIiwiY3JlYXRlVHJhbnNhY3Rpb25hbFNlc3Npb24iLCJwcm9taXNlcyIsInJlcXVlc3RzIiwibWFwIiwicmVxdWVzdCIsImJvZHkiLCJyZXNwb25zZSIsInJldHVyblN0YXR1cyIsInN0YXR1cyIsIl9zdGF0dXMiLCJzdWNjZXNzIiwiZXJyb3IiLCJjb2RlIiwibWVzc2FnZSIsImFsbCIsInJlc3VsdCIsImZpbmQiLCJyZXN1bHRJdGVtIiwiYWJvcnRUcmFuc2FjdGlvbmFsU2Vzc2lvbiIsInJlamVjdCIsImNvbW1pdFRyYW5zYWN0aW9uYWxTZXNzaW9uIiwiY2F0Y2giLCJlcnJvckl0ZW0iLCJxdWVyeSIsImF1dGgiLCJpbmZvIiwiY29udGV4dCIsInRyeVJvdXRlUmVxdWVzdCIsInJlc3AiLCJlcnIiLCJFcnJvciIsIklOVkFMSURfSlNPTiIsImFwcGx5IiwiYWpheCJdLCJt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S0FBSyxDQUFDK0QsS0FBckIsSUFDQUQsR0FBRyxDQUFDakIsSUFBSixJQUFZN0MsS0FBSyxDQUFDK0QsS0FBTixDQUFZQyxZQUR4QixJQUVBRixHQUFHLENBQUNoQixPQUFKLElBQWdCLGdCQUFlN0IsTUFBTyxJQUFHQyxJQUFLLEVBSGhELEVBSUU7QUFDQXBCLFlBQUFBLGNBQWMsQ0FBQ3VDLE9BQWYsQ0FBdUI0QixLQUF2QixDQUE2QixJQUE3QixFQUFtQzdDLElBQW5DLEVBQXlDVCxJQUF6QyxDQUE4Q04sT0FBOUMsRUFBdUQrQyxNQUF2RDtBQUNELFdBTkQsTUFNTztBQUNMQSxZQUFBQSxNQUFNLENBQUNVLEdBQUQsQ0FBTjtBQUNEO0FBQ0YsU0F2QkUsQ0FBUDtBQXlCRCxPQXRDRCxFQXNDR1YsTUF0Q0g7QUF1Q0QsS0F4Q00sQ0FBUDtBQXlDRDs7QUFFRCxTQUFPO0FBQ0xmLElBQUFBLE9BQU8sRUFBRXJCLGFBREo7QUFFTGtELElBQUFBLElBQUksRUFBRXBFLGNBQWMsQ0FBQ29FO0FBRmhCLEdBQVA7QUFJRDs7ZUFFY3JELHlCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQ29uZmlnID0gcmVxdWlyZSgnLi9Db25maWcnKTtcbmNvbnN0IEF1dGggPSByZXF1aXJlKCcuL0F1dGgnKTtcbmNvbnN0IFJFU1RDb250cm9sbGVyID0gcmVxdWlyZSgncGFyc2UvbGliL25vZGUvUkVTVENvbnRyb2xsZXInKTtcbmNvbnN0IFVSTCA9IHJlcXVpcmUoJ3VybCcpO1xuY29uc3QgUGFyc2UgPSByZXF1aXJlKCdwYXJzZS9ub2RlJyk7XG5cbmZ1bmN0aW9uIGdldFNlc3Npb25Ub2tlbihvcHRpb25zKSB7XG4gIGlmIChvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLnNlc3Npb25Ub2tlbiA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG9wdGlvbnMuc2Vzc2lvblRva2VuKTtcbiAgfVxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xufVxuXG5mdW5jdGlvbiBnZXRBdXRoKG9wdGlvbnMgPSB7fSwgY29uZmlnKSB7XG4gIGNvbnN0IGluc3RhbGxhdGlvbklkID0gb3B0aW9ucy5pbnN0YWxsYXRpb25JZCB8fCAnY2xvdWQnO1xuICBpZiAob3B0aW9ucy51c2VNYXN0ZXJLZXkpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBBdXRoLkF1dGgoeyBjb25maWcsIGlzTWFzdGVyOiB0cnVlLCBpbnN0YWxsYXRpb25JZCB9KSk7XG4gIH1cbiAgcmV0dXJuIGdldFNlc3Npb25Ub2tlbihvcHRpb25zKS50aGVuKHNlc3Npb25Ub2tlbiA9PiB7XG4gICAgaWYgKHNlc3Npb25Ub2tlbikge1xuICAgICAgb3B0aW9ucy5zZXNzaW9uVG9rZW4gPSBzZXNzaW9uVG9rZW47XG4gICAgICByZXR1cm4gQXV0aC5nZXRBdXRoRm9yU2Vzc2lvblRva2VuKHtcbiAgICAgICAgY29uZmlnLFxuICAgICAgICBzZXNzaW9uVG9rZW46IHNlc3Npb25Ub2tlbixcbiAgICAgICAgaW5zdGFsbGF0aW9uSWQsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShuZXcgQXV0aC5BdXRoKHsgY29uZmlnLCBpbnN0YWxsYXRpb25JZCB9KSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gUGFyc2VTZXJ2ZXJSRVNUQ29udHJvbGxlcihhcHBsaWNhdGlvbklkLCByb3V0ZXIpIHtcbiAgZnVuY3Rpb24gaGFuZGxlUmVxdWVzdChtZXRob2QsIHBhdGgsIGRhdGEgPSB7fSwgb3B0aW9ucyA9IHt9LCBjb25maWcpIHtcbiAgICAvLyBTdG9yZSB0aGUgYXJndW1lbnRzLCBmb3IgbGF0ZXIgdXNlIGlmIGludGVybmFsIGZhaWxzXG4gICAgY29uc3QgYXJncyA9IGFyZ3VtZW50cztcblxuICAgIGlmICghY29uZmlnKSB7XG4gICAgICBjb25maWcgPSBDb25maWcuZ2V0KGFwcGxpY2F0aW9uSWQpO1xuICAgIH1cbiAgICBjb25zdCBzZXJ2ZXJVUkwgPSBVUkwucGFyc2UoY29uZmlnLnNlcnZlclVSTCk7XG4gICAgaWYgKHBhdGguaW5kZXhPZihzZXJ2ZXJVUkwucGF0aCkgPT09IDApIHtcbiAgICAgIHBhdGggPSBwYXRoLnNsaWNlKHNlcnZlclVSTC5wYXRoLmxlbmd0aCwgcGF0aC5sZW5ndGgpO1xuICAgIH1cblxuICAgIGlmIChwYXRoWzBdICE9PSAnLycpIHtcbiAgICAgIHBhdGggPSAnLycgKyBwYXRoO1xuICAgIH1cblxuICAgIGlmIChwYXRoID09PSAnL2JhdGNoJykge1xuICAgICAgY29uc3QgYmF0Y2ggPSB0cmFuc2FjdGlvblJldHJpZXMgPT4ge1xuICAgICAgICBsZXQgaW5pdGlhbFByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgaWYgKGRhdGEudHJhbnNhY3Rpb24gPT09IHRydWUpIHtcbiAgICAgICAgICBpbml0aWFsUHJvbWlzZSA9IGNvbmZpZy5kYXRhYmFzZS5jcmVhdGVUcmFuc2FjdGlvbmFsU2Vzc2lvbigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpbml0aWFsUHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgICAgICBjb25zdCBwcm9taXNlcyA9IGRhdGEucmVxdWVzdHMubWFwKHJlcXVlc3QgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGhhbmRsZVJlcXVlc3QocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGF0aCwgcmVxdWVzdC5ib2R5LCBvcHRpb25zLCBjb25maWcpLnRoZW4oXG4gICAgICAgICAgICAgIHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZXR1cm5TdGF0dXMpIHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IHJlc3BvbnNlLl9zdGF0dXM7XG4gICAgICAgICAgICAgICAgICBkZWxldGUgcmVzcG9uc2UuX3N0YXR1cztcbiAgICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHJlc3BvbnNlLCBfc3RhdHVzOiBzdGF0dXMgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogcmVzcG9uc2UgfTtcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICBlcnJvcjogeyBjb2RlOiBlcnJvci5jb2RlLCBlcnJvcjogZXJyb3IubWVzc2FnZSB9LFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKVxuICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgaWYgKGRhdGEudHJhbnNhY3Rpb24gPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0LmZpbmQocmVzdWx0SXRlbSA9PiB0eXBlb2YgcmVzdWx0SXRlbS5lcnJvciA9PT0gJ29iamVjdCcpKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gY29uZmlnLmRhdGFiYXNlLmFib3J0VHJhbnNhY3Rpb25hbFNlc3Npb24oKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5kYXRhYmFzZS5jb21taXRUcmFuc2FjdGlvbmFsU2Vzc2lvbigpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgZXJyb3IgJiZcbiAgICAgICAgICAgICAgICBlcnJvci5maW5kKFxuICAgICAgICAgICAgICAgICAgZXJyb3JJdGVtID0+IHR5cGVvZiBlcnJvckl0ZW0uZXJyb3IgPT09ICdvYmplY3QnICYmIGVycm9ySXRlbS5lcnJvci5jb2RlID09PSAyNTFcbiAgICAgICAgICAgICAgICApICYmXG4gICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25SZXRyaWVzID4gMFxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYmF0Y2godHJhbnNhY3Rpb25SZXRyaWVzIC0gMSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgICAgcmV0dXJuIGJhdGNoKDUpO1xuICAgIH1cblxuICAgIGxldCBxdWVyeTtcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcXVlcnkgPSBkYXRhO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBnZXRBdXRoKG9wdGlvbnMsIGNvbmZpZykudGhlbihhdXRoID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgICAgICBib2R5OiBkYXRhLFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICBhdXRoLFxuICAgICAgICAgIGluZm86IHtcbiAgICAgICAgICAgIGFwcGxpY2F0aW9uSWQ6IGFwcGxpY2F0aW9uSWQsXG4gICAgICAgICAgICBzZXNzaW9uVG9rZW46IG9wdGlvbnMuc2Vzc2lvblRva2VuLFxuICAgICAgICAgICAgaW5zdGFsbGF0aW9uSWQ6IG9wdGlvbnMuaW5zdGFsbGF0aW9uSWQsXG4gICAgICAgICAgICBjb250ZXh0OiBvcHRpb25zLmNvbnRleHQgfHwge30sIC8vIEFkZCBjb250ZXh0XG4gICAgICAgICAgfSxcbiAgICAgICAgICBxdWVyeSxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHJvdXRlci50cnlSb3V0ZVJlcXVlc3QobWV0aG9kLCBwYXRoLCByZXF1ZXN0KTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIC50aGVuKFxuICAgICAgICAgICAgcmVzcCA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IHsgcmVzcG9uc2UsIHN0YXR1cyB9ID0gcmVzcDtcbiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMucmV0dXJuU3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh7IC4uLnJlc3BvbnNlLCBfc3RhdHVzOiBzdGF0dXMgfSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnIgPT4ge1xuICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgZXJyIGluc3RhbmNlb2YgUGFyc2UuRXJyb3IgJiZcbiAgICAgICAgICAgICAgICBlcnIuY29kZSA9PSBQYXJzZS5FcnJvci5JTlZBTElEX0pTT04gJiZcbiAgICAgICAgICAgICAgICBlcnIubWVzc2FnZSA9PSBgY2Fubm90IHJvdXRlICR7bWV0aG9kfSAke3BhdGh9YFxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICBSRVNUQ29udHJvbGxlci5yZXF1ZXN0LmFwcGx5KG51bGwsIGFyZ3MpLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICB9LCByZWplY3QpO1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICByZXF1ZXN0OiBoYW5kbGVSZXF1ZXN0LFxuICAgIGFqYXg6IFJFU1RDb250cm9sbGVyLmFqYXgsXG4gIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IFBhcnNlU2VydmVyUkVTVENvbnRyb2xsZXI7XG5leHBvcnQgeyBQYXJzZVNlcnZlclJFU1RDb250cm9sbGVyIH07XG4iXX0=